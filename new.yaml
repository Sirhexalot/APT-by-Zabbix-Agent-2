zabbix_export:
  version: "7.4"
  template_groups:
    - uuid: b985c1e1fbcd48ffbdf2693ffc6fbdea
      name: Templates/Applications
  templates:
    - uuid: ce0d958ce0a8495e9b1381b3e22aa5f9
      template: "Ubuntu- Debian - Updates Management"
      name: "Ubuntu- Debian - Updates Management"
      description: |
        Template for monitoring available updates and installation status

        Requirements:
        - Zabbix Agent 2 in Active mode
        - UserParameters configured on agent

        Agent Configuration (/etc/zabbix/zabbix_agent2.conf or /etc/zabbix/zabbix_agent2.d/userparameters_updates.conf):
        UserParameter=apt.security,apt-get -s upgrade | grep -ci ^inst.*security | tr -d '\n'
        UserParameter=apt.updates,apt-get -s upgrade | grep -iPc '^Inst((?!security).)*$' | tr -d '\n'
        UserParameter=apt.last.update.timestamp,stat -c %Y /var/lib/apt/periodic/update-success-stamp 2>/dev/null || echo 0
        UserParameter=apt.last.upgrade.timestamp,tac /var/log/apt/history.log* 2>/dev/null | awk '/^End-Date:/ {ed=$0} /^(Upgrade|Install):/ && ed {gsub(/End-Date: /, "", ed); system("date -d \"" ed "\" +%s"); exit}' 2>/dev/null || echo 0

        Note: These commands use apt-get -s (simulation mode) which does not require root privileges
        and can be run safely under the zabbix user.

        After adding UserParameters, restart the agent:
        systemctl restart zabbix-agent2
      groups:
        - name: Templates/Applications
      items:
        - uuid: 3bdfefdde2f843eda787c797fcddba6a
          name: "Days since last package list update (apt update)"
          type: DEPENDENT
          key: apt.days.since.last.update
          history: 30d
          value_type: UNSIGNED
          description: "Calculated number of days since last package list update (apt update)"
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var timestamp = parseInt(value);
                  if (timestamp === 0) {
                    return 0;
                  }
                  return Math.floor((Math.floor(new Date().getTime()/1000) - timestamp) / 86400);
          master_item:
            key: apt.last.update.timestamp
          triggers:
            - uuid: b67242e918df49c08c7848ce5e81d3e2
              expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.update)>{$WARN_DAYS}"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.update)<={$WARN_DAYS}"
              name: "Package list not updated for {ITEM.LASTVALUE} days (apt update)"
              priority: WARNING
              description: "Package list update (apt update) not performed for longer than {$WARN_DAYS} days"
              manual_close: "YES"
            - uuid: e3e3683791ec4be8b76d396a904613ab
              expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.update)>{$WARN_DAYS_SECURITY}"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.update)<={$WARN_DAYS_SECURITY}"
              name: "Package list not updated for {ITEM.LASTVALUE} days (security)"
              priority: AVERAGE
              description: "Package list update (apt update) not performed for longer than {$WARN_DAYS_SECURITY} days"
              manual_close: "YES"
        - uuid: e27b527b65ee4b5d87e30287bef0a738
          name: "Last package list update date (apt update)"
          type: ZABBIX_ACTIVE
          key: apt.last.update.timestamp
          history: 30d
          units: unixtime
          description: "Unix timestamp of the last package list update (apt update)"
        - uuid: 333317de405043a08337fbb4856ae3ca
          name: "Last package upgrade date (apt upgrade)"
          type: ZABBIX_ACTIVE
          key: apt.last.upgrade.timestamp
          history: 30d
          units: unixtime
          description: "Unix timestamp of the last package installation/upgrade (apt upgrade/install)"
        - uuid: 262bde0417564d2086e123316294636b
          name: "Days since last package upgrade (apt upgrade)"
          type: DEPENDENT
          key: apt.days.since.last.upgrade
          history: 30d
          value_type: UNSIGNED
          description: "Calculated number of days since last package upgrade/installation"
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var timestamp = parseInt(value);
                  if (timestamp === 0) {
                    return 0;
                  }
                  return Math.floor((Math.floor(new Date().getTime()/1000) - timestamp) / 86400);
          master_item:
            key: apt.last.upgrade.timestamp
          triggers:
            - uuid: 51420b15599e4a3ebfbde507bcebb97b
              expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.upgrade)>{$WARN_DAYS}"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.upgrade)<={$WARN_DAYS}"
              name: "No package upgrades installed for {ITEM.LASTVALUE} days"
              priority: WARNING
              description: "No package upgrades (apt upgrade) performed for longer than {$WARN_DAYS} days"
              manual_close: "YES"
            - uuid: 92ccd3fab0a544e7941f8511d203a0ce
              expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.upgrade)>{$WARN_DAYS_SECURITY}"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.days.since.last.upgrade)<={$WARN_DAYS_SECURITY}"
              name: "No security package upgrades for {ITEM.LASTVALUE} days"
              priority: AVERAGE
              description: "No package upgrades (apt upgrade) performed for longer than {$WARN_DAYS_SECURITY} days (security risk)"
              manual_close: "YES"
        - uuid: 9bcf3d1d5dd64c8198b17e26a2a6b1f7
          name: "Number of available security updates"
          type: ZABBIX_ACTIVE
          key: apt.security
          history: 30d
          units: Updates
          description: "Number of available security updates"
          triggers:
            - uuid: 127aff910ff244499003fcefa0f6b66d
              expression: "last(/Ubuntu- Debian - Updates Management/apt.security)>0"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.security)=0"
              name: "Security updates available - {ITEM.LASTVALUE} updates"
              priority: HIGH
              description: "Security updates are available and should be installed"
        - uuid: c15dd6c621824f89b0fad32491720c4d
          name: "Number of available updates"
          type: ZABBIX_ACTIVE
          key: apt.updates
          history: 30d
          units: Updates
          description: "Number of regular (non-security) updates available"
          triggers:
            - uuid: a814ee654abb4886b3486d5d3b490f2d
              expression: "last(/Ubuntu- Debian - Updates Management/apt.updates)>{$MAX_NOT_INSTALLED_UPDATES}"
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: "last(/Ubuntu- Debian - Updates Management/apt.updates)<={$MAX_NOT_INSTALLED_UPDATES}"
              name: "Too many updates available - {ITEM.LASTVALUE}"
              priority: WARNING
              description: "The number of available updates exceeds the limit of {$MAX_NOT_INSTALLED_UPDATES}"
      macros:
        - macro: "{$MAX_NOT_INSTALLED_UPDATES}"
          value: "5"
          description: "Maximum number of uninstalled updates before alarm is triggered"
        - macro: "{$WARN_DAYS}"
          value: "30"
          description: "Warning if last updates are older than X days"
        - macro: "{$WARN_DAYS_SECURITY}"
          value: "7"
          description: "Warning if last updates are older than X days (security threshold)"
